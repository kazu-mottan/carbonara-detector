# モデル訓練ガイド

このディレクトリには、Carbonara判別モデルの訓練スクリプトが含まれています。

## データ準備

### 1. 画像の配置

約50枚の料理写真を以下のディレクトリに配置してください：

```
training/data/
├── carbonara/          # カルボナーラ画像（25-30枚推奨）
│   ├── carbonara_001.jpg
│   ├── carbonara_002.jpg
│   └── ...
└── not-carbonara/      # その他の料理画像（20-25枚推奨）
    ├── other_001.jpg
    ├── other_002.jpg
    └── ...
```

### 2. 画像の要件

- **形式**: JPEG (.jpg, .jpeg), PNG (.png)
- **推奨サイズ**: 500x500 ~ 1500x1500 ピクセル
- **最小サイズ**: 224x224 ピクセル以上
- **ファイルサイズ**: 10MB以下
- **色空間**: RGB（カラー画像）
- **ファイル名**: 英数字とアンダースコア、ハイフンのみ（日本語不可）

### 3. 画像の多様性

**カルボナーラ画像（25-30枚）:**
- 様々な角度：真上、斜め45度、横から
- 盛り付けバリエーション：皿、ボウル、パスタの形状
- 照明条件：自然光、室内照明、レストラン照明
- 具材のバリエーション：ベーコン/パンチェッタ、卵黄の有無

**その他料理画像（20-25枚）:**
- 類似パスタ料理：ペペロンチーノ、ボロネーゼ、カルボナーラ風
- その他料理：リゾット、ピザ、サラダ、スープ
- 目的：カルボナーラとの識別を困難にする類似料理を含める

## 訓練の実行

### 1. 依存関係のインストール（初回のみ）

```bash
cd training
npm install
```

### 2. 訓練の開始

```bash
npm run train
```

### 3. 訓練の流れ

1. データ読み込み（carbonara/, not-carbonara/）
2. データをシャッフルして訓練/検証に分割（80%/20%）
3. MobileNetV2の事前訓練モデルを読み込み
4. カスタム分類層を追加
5. 訓練開始（最大40エポック、Early Stopping有効）
6. モデル保存（`../public/models/`）

### 4. 訓練の出力例

```
🍝 Carbonara Detector - モデル訓練開始

設定:
  画像サイズ: 224x224
  バッチサイズ: 8
  エポック数: 40
  学習率: 0.0001
  検証データ割合: 20%

📊 データセットを準備中...

📁 /path/to/training/data/carbonara から画像を読み込み中...
  見つかった画像: 28枚
  正常に読み込まれた画像: 28枚

📁 /path/to/training/data/not-carbonara から画像を読み込み中...
  見つかった画像: 22枚
  正常に読み込まれた画像: 22枚

合計画像数: 50枚
  カルボナーラ: 28枚
  その他: 22枚

訓練データ: 40枚
検証データ: 10枚

🏗️  モデルを構築中...

✅ MobileNetV2ロード完了

📋 モデルアーキテクチャ:
_________________________________________________________________
Layer (type)                 Output shape              Param #
=================================================================
mobilenetv2_1.00_224 (Functional) [null,1280]         2257984
_________________________________________________________________
dense_Dense1 (Dense)         [null,128]                163968
_________________________________________________________________
dropout_Dropout1 (Dropout)   [null,128]                0
_________________________________________________________________
dense_Dense2 (Dense)         [null,2]                  258
=================================================================
Total params: 2422210
Trainable params: 164226
Non-trainable params: 2257984
_________________________________________________________________

🚀 訓練開始...

Epoch 1/40
  Batch 5/5 - loss: 0.6234 - acc: 0.6500 - val_loss: 0.4521 - val_acc: 0.8000
  🎉 新しいベストモデル（検証精度: 80.00%）

Epoch 2/40
  Batch 5/5 - loss: 0.3912 - acc: 0.8250 - val_loss: 0.3124 - val_acc: 0.9000
  🎉 新しいベストモデル（検証精度: 90.00%）

...

✅ 訓練完了！
最高検証精度: 92.00%

💾 モデルを保存中...
✅ モデルを保存しました: /path/to/public/models
  - model.json
  - weights.bin

🎊 すべての処理が完了しました！

次のステップ:
  1. public/models/ にモデルファイルが保存されていることを確認
  2. npm run dev でフロントエンドを起動してテスト
```

## 訓練パラメータの調整

`train.js` の `CONFIG` オブジェクトで以下のパラメータを調整できます：

```javascript
const CONFIG = {
  imageSize: 224,           // 入力画像サイズ（MobileNetV2のデフォルト）
  batchSize: 8,             // バッチサイズ（メモリに応じて調整）
  epochs: 40,               // 最大エポック数
  learningRate: 0.0001,     // 学習率
  validationSplit: 0.2,     // 検証データの割合（0.0-1.0）
  dataAugmentation: true,   // データ拡張の有効/無効
  modelSavePath: '...',     // モデル保存先
  dataPath: '...',          // データディレクトリ
};
```

## トラブルシューティング

### 画像が見つからない

**エラー**: `画像が見つかりません。training/data/ 配下に画像を配置してください。`

**解決策**:
- `training/data/carbonara/` と `training/data/not-carbonara/` に画像ファイルがあるか確認
- ファイル拡張子が `.jpg`, `.jpeg`, `.png` のいずれかか確認

### メモリ不足エラー

**エラー**: `Out of memory` や `FATAL ERROR: ... Reached heap limit`

**解決策**:
- `CONFIG.batchSize` を小さくする（8 → 4 または 2）
- Node.jsのメモリ上限を増やす: `node --max-old-space-size=4096 train.js`

### 訓練が収束しない

**症状**: 精度が50%付近で停滞

**解決策**:
- データの品質を確認（ラベルが正しいか）
- 画像の多様性を増やす（様々な角度、照明）
- `CONFIG.learningRate` を調整（0.0001 → 0.00005）
- `CONFIG.epochs` を増やす（40 → 60）

### 過学習（Overfitting）

**症状**: 訓練精度は高いが検証精度が低い

**解決策**:
- データ拡張を確認（`CONFIG.dataAugmentation: true`）
- Dropout率を上げる（train.jsの `dropout({ rate: 0.5 })` → `0.6`）
- より多くの画像データを追加

### MobileNetV2のダウンロードに失敗

**エラー**: `Failed to fetch MobileNetV2 model`

**解決策**:
- インターネット接続を確認
- プロキシ設定を確認
- ファイアウォールがHTTPSアクセスをブロックしていないか確認

## モデル評価

訓練後、以下を確認してください：

1. **検証精度**: 80%以上が目標
2. **過学習の兆候**: 訓練精度と検証精度の差が10%以内
3. **モデルファイル**: `public/models/model.json` と `*.bin` が存在

検証精度が低い場合：
- より多くの高品質な画像を追加
- データの多様性を確保
- 類似した料理（他のパスタ料理）を not-carbonara/ に追加

## 次のステップ

訓練が完了したら：

1. フロントエンドで動作確認
   ```bash
   cd ..
   npm run dev
   ```

2. ブラウザで http://localhost:5173 にアクセス

3. 画像をアップロードして判別テスト

4. 精度が低い場合はデータを追加して再訓練
